version: "2.1"
services:

        database:
                image: linuxserver/mariadb
                environment:
                        - PUID=1000
                        - PGID=1000
                        - TZ=Europe/Paris
                        - MYSQL_ROOT_PASSWORD=${DATABASE_ROOT_PASSWORD}
                        - MYSQL_DATABASE=${DATABASE_NAME}
                        - MYSQL_USER=${DATABASE_USER}
                        - MYSQL_PASSWORD=${DATABASE_PASSWORD}
                ports:
                        - "3306:3306"
                volumes:
                        - ./database/data/:/config

        php-fpm:
                build:
                        context: ./php-fpm
                depends_on:
                        - database
                environment:
                        - APP_ENV=${APP_ENV}
                        - APP_SECRET=${APP_SECRET}
                        - DATABASE_URL=mysql://${DATABASE_USER}:${DATABASE_PASSWORD}@database:3306/${DATABASE_NAME}?serverVersion=mariadb-10.4.10
                volumes:
                        - ../backend/:/var/www

        nextjs:
                build:
                        context: ./nextjs
                depends_on:
                        - php-fpm
                        - nginx
                environment:
                        - SERVEUR_URL=https://nginx
                        # Disable self-signed cert verification
                        - NODE_TLS_REJECT_UNAUTHORIZED=0
                volumes:
                        - ../frontend/:/var/www

        nginx:
                build:
                           context: ./nginx
                depends_on:
                        - php-fpm
                volumes:
                        - ../backend/:/var/www
                        - ./nginx/nginx.conf:/etc/nginx/nginx.conf
                        - ./nginx/sites/:/etc/nginx/sites-available
                        - ./nginx/conf.d/:/etc/nginx/conf.d
                        - ./nginx/ssl/:/etc/ssl
                        - ./logs:/var/log
                ports:
                        - "80:80"
                        - "443:443"
